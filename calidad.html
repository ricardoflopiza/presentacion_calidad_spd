<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Capacitación paquete calidad</title>
    <meta charset="utf-8" />
    <meta name="author" content="" />
    <meta name="date" content="2021-12-06" />
    <script src="calidad_files/kePrint-0.0.1/kePrint.js"></script>
    <link href="calidad_files/lightable-0.0.1/lightable.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">


class: center, middle

.linea-superior[]
.linea-inferior[]

&lt;img src="imagenes/logo_portada2.png" width="200" /&gt;

## Capacitación en uso paquete calidad para 
Subsecretaría prevención del delito

## Subdepartamento condiciones de vida 
**INE**

### Diciembre 2021





---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Estructura del taller


- Breve repaso del estándar de calidad para las estimaciones en encuestas de hogares del INE

--

- Recordar de manera general el paquete `survey`

--

- Presentación y ejercicios prácticos con el paquete `calidad`, desarrollado por el PE SSCC. 

--

**Objetivo del taller**

- Presentar principales funciones del paquete de `calidad` para la implementación del estandar de calidad porpuesto por el INE, con datos de ENUSC.

--

### Asumiremos un conocimiento básico de R

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Estándar de calidad INE

Desde 2020, el INE cuenta con un [estándar](https://www.ine.cl/docs/default-source/documentos-de-trabajo/20200318-lineamientos-medidas-de-precisi%C3%B3n.pdf?sfvrsn=f1ab2dbe_4) para evaluar la calidad de estimaciones provenientes de encuestas de hogares


.center[
&lt;img src="imagenes/estandar.png" width="600" /&gt;
]

--

Nos permite determinar si una estimación es **fiable, poco fiable o no fiable** 

--

Nos orienta respecto a si un tabulado debe ser publicado o no


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Aspectos generales del estándar

Existe un flujo, que nos permite etiquetar **automáticamente** cada estimación 

--

.center[
&lt;img src="imagenes/flujo.png" width="650" /&gt;
]

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Aspectos generales del estándar

## El flujo establece caminos diferenciados

--

### Estimaciones de proporción (o razón) entre **0 y 1**

- Tamaño muestral
- Grados de libertad
- .red[Error estándar] 

--

### Resto de estimaciones

- Tamaño muestral
- Grados de libertad
- .red[Coeficiente de variación] 
 

### En un caso usamos el SE y en otro el CV

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Introducción paquete calidad

### ¿Cómo pasar del documento a la práctica?

.center[
&lt;img src="https://media.giphy.com/media/a5viI92PAF89q/giphy.gif" width="200" /&gt;
]

--

Existen múltiples herramientas (Stata, R, SAS, Python) y todas son válidas

--

Múltiples modalidades dentro de cada herramienta (libertad total, scripts estandarizados, funciones, etc)

--

Es útil contar con una herramienta que **estandarice** los criterios de calidad



---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Introducción paquete calidad

Una posibilidad es el uso de un **paquete (librería)**

--

El paquete `calidad` implementa el estándar mediante `R`

--

### Objetivos del paquete

- Facilitar la aplicación del estándar a usuarios externos
- Aumentar la eficiencia en el trabajo de los analistas
- Reducir la probabilidad de error en la implementación

--

El paquete `calidad` combina el estándar del INE con el paquete `survey`, desarrollado por Thomas Lumley


.center[
&lt;img src="imagenes/ecuacion.png" width="450" /&gt;
]

--

.center[
### Revisaremos velozmente el paquete survey
]


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Brevísima revisión de survey

Usaremos los datos de ENUSC 2020 y 2019



```r
library(readr)
library(tidyverse)

# enusc &lt;- haven::read_sav("base-de-datos---xvi-enusc-2019.sav")
enusc &lt;- feather::read_feather("data/enusc2019.feather")
```
--

Construyamos variables necesarias para hacer algunos cálculos


```r
### Seleccionamos a los casos kish 
enusc = enusc[enusc$Kish == 1,]

### percepción de inseguridad por sexo
enusc = enusc %&gt;%  mutate(muj_insg_taxi = dplyr::if_else(enusc$P9_4_1 %in% c(1,2) &amp; enusc$rph_sexo == 2,1 ,0),
                          hom_insg_taxi = dplyr::if_else(enusc$P9_4_1 %in% c(1,2) &amp; enusc$rph_sexo == 1,1 ,0))

enusc$muj_insg_micro = if_else(enusc$P9_3_1 %in% c(1,2) &amp; enusc$rph_sexo == 2,1 ,0)
enusc$hom_insg_micro = if_else(enusc$P9_3_1 %in% c(1,2) &amp; enusc$rph_sexo == 1,1 ,0)

enusc$robo_vehiculo = if_else(enusc$G1_1_1 == 1,1,0)
```

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Brevísima revisión de survey

En primer lugar, declaramos el diseño complejo con la función `svydesign`

```r
library(survey)

### declaramos diseño complejo con el factor de personas
dcPers &lt;- svydesign(ids = ~Conglomerado, strata = ~VarStrat,
                     data = enusc, weights = ~Fact_Pers)

### declaramos diseño complejo con el factor de hogares
dcHog &lt;- svydesign(ids = ~Conglomerado, strata = ~VarStrat,
                     data = enusc, weights = ~Fact_Hog)
```

Debemos declarar:
- conglomerados de varianza
- estratos de varianza
- factor de expansión

--

Es importante indicarle a `survey` qué hacer cuando existen estratos que solo tienen una UPM 


```r
options(survey.lonely.psu = "certainty")
```


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Brevísima revisión de survey

### Ahora podemos usar los paquetes `survey` y  `calidad` para diferentes tipos de cálculos 😃😃😃😃😃

--

**Calculemos la Victimización Personal de Delitos Consumados**


```r
svymean(x = ~VP_DC,dcPers)
```

```
##           mean     SE
## VP_DC 0.088765 0.0031
```
--

**Calculemos la Victimización Personal de Delitos Consumados por regiones**


```r
svyby(formula = ~VP_DC, design = dcPers, by = ~enc_region, FUN = svymean)
```

```
##    enc_region      VP_DC          se
## 1           1 0.07993473 0.007701148
## 2           2 0.08128018 0.020508631
## 3           3 0.06414257 0.012003051
## 4           4 0.06189114 0.009213642
## 5           5 0.08686060 0.007175882
## 6           6 0.08269119 0.009323766
## 7           7 0.06473373 0.009821965
## 8           8 0.07731794 0.007510670
## 9           9 0.06988969 0.012007138
## 10         10 0.06167374 0.006262698
## 11         11 0.04385555 0.009900581
## 12         12 0.06618068 0.013679873
## 13         13 0.10678108 0.005791957
## 14         14 0.07398586 0.011835333
## 15         15 0.08456983 0.011708343
## 16         16 0.07464146 0.007389251
```
--

**Calculemos la inseguridad de las mujeres en taxis por sobre los hombres**


```r
svyratio(numerator = ~muj_insg_taxi, denominator = ~hom_insg_taxi, dcPers)
```
---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Brevísima revisión de survey

`survey` permite hacer una infinidad de cálculos 

- `svymean`
- `svytotal`
- `svyratio`
- `svyby`
- `svyquantile`

--

Mediante la función `as.svrepdesign` podemos, además, utilizar métodos de remuestreo

- intervalos de confianza de percentiles
- cv de percentiles

--

.center[
### El paquete survey es una gran herramienta que nos hace la vida más fácil 
]

.center[
&lt;img src="https://media.giphy.com/media/l3V0dy1zzyjbYTQQM/giphy.gif" width="250" /&gt;
]




---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Instalación paquete calidad

Lo primero, es descargar el paquete desde `github`

Se requiere el paquete `devtools`


```r
library(devtools)
install_github("inesscc/calidad")
```

--

### En la consola, aparecerá el siguiente mensaje


.center[
&lt;img src="imagenes/consola.png" width="350" /&gt;
]

### Debes escribir 3 en la consola y luego enter

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Panorama general

Lo siguiente, es cargar el paquete en la sesión


```r
library(calidad)
```

El paquete `calidad` tiene 2 grandes familias de funciones:

- *create_*: permiten **crear** los insumos para el estándar
- *evaluate_*: permiten hacer la **evaluación** del estándar

--

Podemos hacer los siguientes cálculos

- `create_mean`: calcular la media (edad)
- `create_prop`: proporción o razón (VP_DC, ocupación) 
- `create_tot`: conteo de unidades (ocupación)
- `create_tot_con`: suma de variables continuas (ingreso)
- `create_median`: mediana (edad, ingreso)

--

### Estas funciones devuelven la estimación y los insumos para el estándar

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Panorama general

Queremos calcular la edad media para mujeres y hombres

--


```r
 create_mean(var = edad_numerica, dominios = rph_sexo, disenio = dcPers)
```

- `var`: variable a estimar
- `dominios`: desagregaciones
- `disenio`: diseño muestral creado con `svydesign`

--

La función genera:
- estimación 
- error estándar (se)
- grados de libertad (gl)
- tamaño muestral (n)
- coeficiente de variación (coef_var)

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Panorama general

A diferencia de `survey`, en el paquete `calidad` no es necesario utilizar ~  


```r
# Argumentos con paquete survey
 svyby(formula = ~rph_edad, by = ~rph_sexo, design =  dcPers, FUN = svymean) 
```


--

Tampoco se requiere que los argumentos estén escritos como *strings*

--

Sin embargo, existe la libertad para usar *strings*


```r
# Argumentos con paquete calidad
 create_prop(var = "VP_DC", dominios = rph_sexo,  disenio = dcPers)
```

```
##   rph_sexo   objetivo          se   coef_var  gl     n
## 1        1 0.07202257 0.004467007 0.06202232 486 10732
## 2        2 0.10465826 0.004828901 0.04613971 486 13733
```

--

Ya veremos por qué podría ser útil que los argumentos sean strings

.center[
&lt;img src="https://media.giphy.com/media/xUPGcz2H1TXdCz4suY/giphy.gif" width="150" /&gt;
]


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_prop

Calculemos los robos de vehículos, 
--

Para ello, contamos con la función `create_prop`

--

Podríamos hacer algo similar a lo anterior



```r
create_prop(var = robo_vehiculo, disenio = dcHog)
```

```
##               objetivo  se  gl     n coef_var
## robo_vehiculo       NA NaN 486 24465      NaN
```

--

El problema es que el robo de vehículos debe calcularse sobre una subpoblación específica (quienes poseen vehículos)

--

Para ello, utilizamos el argumento `subpop`


```r
enusc$poseen_vehiculo = if_else(enusc$F1_1_1 == 1,1,0)

dcHog &lt;- svydesign(ids = ~Conglomerado, strata = ~VarStrat,
                     data = enusc, weights = ~Fact_Hog)
# G1: Durante los últimos doce meses, ¿a usted o a algún miembro de su hogar le fue robado su automóvil, camioneta o motocicleta?
create_prop(var = robo_vehiculo, subpop = poseen_vehiculo, disenio = dcHog)
```

```
##                 objetivo          se  gl     n  coef_var
## robo_vehiculo 0.01013979 0.002706309 486 12190 0.2668999
```

--

Es muy importante considerar que la variable **subpop debe ser dummy** 


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_prop

¿Qué pasa si queremos desagregar por más variables?

--

Se debe agregar otra variable utilizando un signo +


```r
create_prop(var = VP_DC, dominios = rph_sexo+enc_region, disenio = dcPers)
```

```
##    rph_sexo enc_region   objetivo          se   coef_var  gl    n
## 1         1          1 0.05609711 0.007476203 0.13327253  31  660
## 2         2          1 0.10402761 0.013794789 0.13260700  31  768
## 3         1          2 0.06355077 0.024850464 0.39103325  19  457
## 4         2          2 0.10009961 0.028937636 0.28908841  19  477
## 5         1          3 0.07858772 0.016510180 0.21008601  19  419
## 6         2          3 0.04956982 0.013034538 0.26295313  19  492
## 7         1          4 0.05677053 0.015114090 0.26623125  29  636
## 8         2          4 0.06671310 0.010545443 0.15807154  29  797
## 9         1          5 0.06871715 0.010869955 0.15818401  41  950
## 10        2          5 0.10399168 0.009074560 0.08726236  41 1242
## 11        1          6 0.07305605 0.017872024 0.24463442  21  442
## 12        2          6 0.09234750 0.013716317 0.14852939  21  630
## 13        1          7 0.05648653 0.011942203 0.21141684  34  738
## 14        2          7 0.07253792 0.012449019 0.17162084  34  930
## 15        1          8 0.06330725 0.011388203 0.17988781  45  964
## 16        2          8 0.09108941 0.011009543 0.12086523  45 1263
## 17        1          9 0.05113731 0.015345359 0.30008147  16  352
## 18        2          9 0.08676885 0.013825196 0.15933364  16  509
## 19        1         10 0.04548848 0.010728672 0.23585469  22  454
## 20        2         10 0.07795147 0.012461153 0.15985784  22  634
## 21        1         11 0.06031752 0.018648977 0.30918010  14  304
## 22        2         11 0.02650071 0.006880242 0.25962482  14  378
## 23        1         12 0.07055466 0.026042045 0.36910455  13  274
## 24        2         12 0.06172163 0.014530118 0.23541372  13  335
## 25        1         13 0.08434379 0.008687916 0.10300600 104 2539
## 26        2         13 0.12759004 0.009587375 0.07514203 104 3246
## 27        1         14 0.08888425 0.022077427 0.24838403  27  497
## 28        2         14 0.06013684 0.016121298 0.26807691  27  722
## 29        1         15 0.06334548 0.017899820 0.28257454  17  361
## 30        2         15 0.10085657 0.015424668 0.15293667  17  453
## 31        1         16 0.06156814 0.010696191 0.17372932  34  685
## 32        2         16 0.08689940 0.012731496 0.14650844  34  857
```

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_prop

Queremos calcula la percepción de inseguridad de las mujeres cuando viajan taxis por sobre la percepción inseguridad de los hombres. 

$$  \frac{InseguridadTaxisMujeres}{InseguridadTaxisHombres}$$

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_prop

La función `create_prop` permite incluir el argumento `denominador`


```r
create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi, disenio = dcPers)
```

```
##               objetivo         se   coef_var  gl    n
## muj_insg_taxi 1.692642 0.07495645 0.04428369 485 6381
```
--

Podemos agregar el parámetro `dominios`, si queremos desagregar 



```r
 create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi,dominios = enc_region, disenio = dcPers)
```

```
##    enc_region objetivo        se   coef_var  gl    n
## 1           1 1.636580 0.1028153 0.06282326  31  623
## 2           2 2.103698 0.2427284 0.11538175  19  250
## 3           3 2.406244 0.4047180 0.16819489  19  255
## 4           4 2.057738 0.3866671 0.18790882  29  273
## 5           5 1.508744 0.1790266 0.11865937  41  580
## 6           6 1.526462 0.2766112 0.18121067  21  256
## 7           7 1.904566 0.2173205 0.11410501  34  396
## 8           8 2.073867 0.3019685 0.14560646  45  505
## 9           9 1.664736 0.2290404 0.13758359  16  208
## 10         10 2.202464 0.5430976 0.24658636  22  252
## 11         11 1.519886 0.2777602 0.18275073  13   75
## 12         12 2.528170 0.7761151 0.30698693  13  109
## 13         13 1.552181 0.1196969 0.07711533 104 1783
## 14         14 2.119325 0.4073396 0.19220253  27  288
## 15         15 3.075978 0.4058491 0.13194150  17  201
## 16         16 1.734623 0.3090289 0.17815336  34  327
```

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: median-mean

Para calcular la media de edad por sexo, usamos la función `create_mean`


```r
 create_mean(var = edad_numerica, dominios = rph_sexo, disenio = dcPers)
```
--

Para calcular la mediana, usamos `create_median`

En este caso, el valor por defecto para el número de réplicas es 10, pero podemos elegir el valor que queramos


```r
 create_median(var = edad_numerica, dominios = rph_sexo, disenio = dcPers, replicas = 50)
```

--

.red[¡¡El tiempo de ejecución aumenta significativamente con el número de réplicas!!]


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_tot

Si queremos un conteo de casos, podemos usar `create_tot`

--

Por ejemplo, número de propietarios de vehículos por región

--


```r
create_tot(poseen_vehiculo, dominios = enc_region,disenio = dcHog)
```

```
##    enc_region      total        se    n  gl   coef_var
## 1           1   60596.15  3477.441  905  31 0.05738716
## 2           2  107664.13 10662.702  521  19 0.09903671
## 3           3   40377.89  4070.423  458  19 0.10080822
## 4           4  110153.76  8702.002  742  29 0.07899869
## 5           5  285925.12 19827.225 1045  41 0.06934412
## 6           6  104671.39  9493.786  478  21 0.09070087
## 7           7  128920.04  8949.580  817  34 0.06941962
## 8           8  279918.62 18275.425 1110  45 0.06528835
## 9           9  113694.47 10136.599  375  16 0.08915648
## 10         10  105696.24 11931.572  470  22 0.11288549
## 11         11   19887.52  1059.646  365  14 0.05328197
## 12         12   34466.88  2379.201  418  13 0.06902863
## 13         13 1054735.64 48909.064 2635 104 0.04637092
## 14         14   46142.05  4690.953  559  27 0.10166329
## 15         15   26730.66  2121.971  518  17 0.07938342
## 16         16   60013.01  7197.480  774  34 0.11993200
```

--

.red[Se requiere que la variable a estimar sea dummy]

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Argumentos adicionales

Hasta el momento hemos revisado 

- `create_prop`
- `create_mean`
- `create_median`
- `create_tot`

--

Todas las funciones del paquete operan de manera similar


--

Contamos argumentos opcionales 

- `ci`: para obtener intervalos de confianza 

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Argumentos adicionales

Queremos calcular el intervalo de confianza para la media de edad


```r
create_mean(var = edad_numerica, dominios = rph_sexo, disenio = dcPers, ci = T)
```

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;br&gt;

.center[
  .big[Evaluación del estándar] 
]


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluación del estándar

Existe una función de evaluación para cada tipo de estimación

- `evaluate_mean`
- `evaluate_prop`
- `evaluate_tot`
- `evaluate_tot_con`
- `evaluate_median`

--

Estas funciones reciben como argumento la tabla creada por las funciones `create_*`



---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluación del estándar

Evaluemos si la victimización acumulada, cumple con el estándar

--


```r
 est &lt;- create_prop(var = VA_DC, dominios = rph_sexo, disenio = dcHog)
 evaluate_mean(est)
```

```
##   rph_sexo  objetivo          se   coef_var  gl     n       eval_n
## 1        1 0.2221248 0.007266813 0.03271501 486 10732 n suficiente
## 2        2 0.2421293 0.007158995 0.02956683 486 13733 n suficiente
##         eval_gl    eval_cv calidad
## 1 gl suficiente cv &lt;= 0.15  fiable
## 2 gl suficiente cv &lt;= 0.15  fiable
```

--

Tenemos 4 columnas nuevas

- `eval_n`: indica si el tamaño muestral es suficiente
- `eval_gl`: indica si los gl son suficientes
- `eval_cv`: indica el tramo en el que está el cv
- `calidad`: evaluación final de la estimación


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluación del estándar

Veamos el caso de Victimización de Delitos Consumados


```r
 est &lt;- create_prop(var = VP_DC, dominios = enc_region, disenio = dcPers)
 evaluate_prop(est)
```

```
##    enc_region   objetivo          se   coef_var  gl    n       eval_n
## 1           1 0.07993473 0.007701148 0.09634296  31 1428 n suficiente
## 2           2 0.08128018 0.020508631 0.25232020  19  934 n suficiente
## 3           3 0.06414257 0.012003051 0.18713080  19  911 n suficiente
## 4           4 0.06189114 0.009213642 0.14886852  29 1433 n suficiente
## 5           5 0.08686060 0.007175882 0.08261377  41 2192 n suficiente
## 6           6 0.08269119 0.009323766 0.11275405  21 1072 n suficiente
## 7           7 0.06473373 0.009821965 0.15172870  34 1668 n suficiente
## 8           8 0.07731794 0.007510670 0.09714006  45 2227 n suficiente
## 9           9 0.06988969 0.012007138 0.17180126  16  861 n suficiente
## 10         10 0.06167374 0.006262698 0.10154562  22 1088 n suficiente
## 11         11 0.04385555 0.009900581 0.22575435  14  682 n suficiente
## 12         12 0.06618068 0.013679873 0.20670492  13  609 n suficiente
## 13         13 0.10678108 0.005791957 0.05424142 104 5785 n suficiente
## 14         14 0.07398586 0.011835333 0.15996751  27 1219 n suficiente
## 15         15 0.08456983 0.011708343 0.13844587  17  814 n suficiente
## 16         16 0.07464146 0.007389251 0.09899659  34 1542 n suficiente
##          eval_gl prop_est tipo_eval cuadratica     eval_se eval_cv calidad
## 1  gl suficiente &lt;= a 0.5   Eval SE 0.02061806 SE adecuado    &lt;NA&gt;  fiable
## 2  gl suficiente &lt;= a 0.5   Eval SE 0.02084878 SE adecuado    &lt;NA&gt;  fiable
## 3  gl suficiente &lt;= a 0.5   Eval SE 0.01780417 SE adecuado    &lt;NA&gt;  fiable
## 4  gl suficiente &lt;= a 0.5   Eval SE 0.01738507 SE adecuado    &lt;NA&gt;  fiable
## 5  gl suficiente &lt;= a 0.5   Eval SE 0.02179245 SE adecuado    &lt;NA&gt;  fiable
## 6  gl suficiente &lt;= a 0.5   Eval SE 0.02108937 SE adecuado    &lt;NA&gt;  fiable
## 7  gl suficiente &lt;= a 0.5   Eval SE 0.01791340 SE adecuado    &lt;NA&gt;  fiable
## 8  gl suficiente &lt;= a 0.5   Eval SE 0.02016559 SE adecuado    &lt;NA&gt;  fiable
## 9  gl suficiente &lt;= a 0.5   Eval SE 0.01885238 SE adecuado    &lt;NA&gt;  fiable
## 10 gl suficiente &lt;= a 0.5   Eval SE 0.01734434 SE adecuado    &lt;NA&gt;  fiable
## 11 gl suficiente &lt;= a 0.5   Eval SE 0.01381785 SE adecuado    &lt;NA&gt;  fiable
## 12 gl suficiente &lt;= a 0.5   Eval SE 0.01817935 SE adecuado    &lt;NA&gt;  fiable
## 13 gl suficiente &lt;= a 0.5   Eval SE 0.02500846 SE adecuado    &lt;NA&gt;  fiable
## 14 gl suficiente &lt;= a 0.5   Eval SE 0.01958198 SE adecuado    &lt;NA&gt;  fiable
## 15 gl suficiente &lt;= a 0.5   Eval SE 0.02140759 SE adecuado    &lt;NA&gt;  fiable
## 16 gl suficiente &lt;= a 0.5   Eval SE 0.01969749 SE adecuado    &lt;NA&gt;  fiable
```
--

Además de las columnas ya vistas, tenemos 

- `prop_est`
- `tipo_eval`
- `cuadratica`
- `eval_se`
- `eval_cv`

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluación del estándar

Veamos qué pasa con las proporciones que son mayores a 1, como la percepción de inseguridad en taxis


```r
 est &lt;- create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi,dominios = enc_region, disenio = dcPers)
 evaluate_prop(est)
```

```
##    enc_region objetivo        se   coef_var  gl    n       eval_n       eval_gl
## 1           1 1.636580 0.1028153 0.06282326  31  623 n suficiente gl suficiente
## 2           2 2.103698 0.2427284 0.11538175  19  250 n suficiente gl suficiente
## 3           3 2.406244 0.4047180 0.16819489  19  255 n suficiente gl suficiente
## 4           4 2.057738 0.3866671 0.18790882  29  273 n suficiente gl suficiente
## 5           5 1.508744 0.1790266 0.11865937  41  580 n suficiente gl suficiente
## 6           6 1.526462 0.2766112 0.18121067  21  256 n suficiente gl suficiente
## 7           7 1.904566 0.2173205 0.11410501  34  396 n suficiente gl suficiente
## 8           8 2.073867 0.3019685 0.14560646  45  505 n suficiente gl suficiente
## 9           9 1.664736 0.2290404 0.13758359  16  208 n suficiente gl suficiente
## 10         10 2.202464 0.5430976 0.24658636  22  252 n suficiente gl suficiente
## 11         11 1.519886 0.2777602 0.18275073  13   75 n suficiente gl suficiente
## 12         12 2.528170 0.7761151 0.30698693  13  109 n suficiente gl suficiente
## 13         13 1.552181 0.1196969 0.07711533 104 1783 n suficiente gl suficiente
## 14         14 2.119325 0.4073396 0.19220253  27  288 n suficiente gl suficiente
## 15         15 3.075978 0.4058491 0.13194150  17  201 n suficiente gl suficiente
## 16         16 1.734623 0.3090289 0.17815336  34  327 n suficiente gl suficiente
##    prop_est tipo_eval cuadratica eval_se             eval_cv     calidad
## 1    &gt;= a 1   Eval CV         NA    &lt;NA&gt;          cv &lt;= 0.15      fiable
## 2    &gt;= a 1   Eval CV         NA    &lt;NA&gt;          cv &lt;= 0.15      fiable
## 3    &gt;= a 1   Eval CV         NA    &lt;NA&gt; cv entre 0.15 y 0.3 poco fiable
## 4    &gt;= a 1   Eval CV         NA    &lt;NA&gt; cv entre 0.15 y 0.3 poco fiable
## 5    &gt;= a 1   Eval CV         NA    &lt;NA&gt;          cv &lt;= 0.15      fiable
## 6    &gt;= a 1   Eval CV         NA    &lt;NA&gt; cv entre 0.15 y 0.3 poco fiable
## 7    &gt;= a 1   Eval CV         NA    &lt;NA&gt;          cv &lt;= 0.15      fiable
## 8    &gt;= a 1   Eval CV         NA    &lt;NA&gt;          cv &lt;= 0.15      fiable
## 9    &gt;= a 1   Eval CV         NA    &lt;NA&gt;          cv &lt;= 0.15      fiable
## 10   &gt;= a 1   Eval CV         NA    &lt;NA&gt; cv entre 0.15 y 0.3 poco fiable
## 11   &gt;= a 1   Eval CV         NA    &lt;NA&gt; cv entre 0.15 y 0.3 poco fiable
## 12   &gt;= a 1   Eval CV         NA    &lt;NA&gt;            cv &gt; 0.3   no fiable
## 13   &gt;= a 1   Eval CV         NA    &lt;NA&gt;          cv &lt;= 0.15      fiable
## 14   &gt;= a 1   Eval CV         NA    &lt;NA&gt; cv entre 0.15 y 0.3 poco fiable
## 15   &gt;= a 1   Eval CV         NA    &lt;NA&gt;          cv &lt;= 0.15      fiable
## 16   &gt;= a 1   Eval CV         NA    &lt;NA&gt; cv entre 0.15 y 0.3 poco fiable
```

--

**En este caso, usamos el CV para hacer la evaluación y no el SE** 


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluación del estándar

El estándar señala que un tabulado puede ser publicado si el 50% de sus celdas es fiable

--

Para saber si el tabulado debe ser publicado, usamos el argumento `publicar`


```r
est &lt;-  create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi,dominios = enc_region, disenio = dcPers)
evaluate_tot(est, publicar = T) %&gt;%
  select(enc_region, objetivo, calidad, publicacion, aprueba) %&gt;%
  slice(1:6)
```

```
##   enc_region objetivo     calidad       publicacion                     aprueba
## 1          1 1.636580      fiable publicar tabulado 50% de estimaciones fiables
## 2          2 2.103698      fiable publicar tabulado 50% de estimaciones fiables
## 3          3 2.406244 poco fiable publicar tabulado 50% de estimaciones fiables
## 4          4 2.057738 poco fiable publicar tabulado 50% de estimaciones fiables
## 5          5 1.508744      fiable publicar tabulado 50% de estimaciones fiables
## 6          6 1.526462 poco fiable publicar tabulado 50% de estimaciones fiables
```

--

Tenemos 2 nuevas columnas

- `publicacion`: evaluación general del tabulado
- `aprueba`: porcentaje de celdas con categoría fiable

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Visualización estándar

La función `tabla_html` aún está en desarrollo, pero ya está disponible para ser usada

Recibe como argumento el output de `evaluate` 



```r
 tabla_html(evaluate_tot(est) %&gt;% slice(1:5)) 
```

&lt;table style='color: black; font-family: arial; width: auto !important; margin-left: auto; margin-right: auto; font-family: "Arial Narrow", arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;' class="table table-striped lightable-paper lightable-hover"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; enc_region &lt;/th&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; objetivo &lt;/th&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; se &lt;/th&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; coef_var &lt;/th&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; gl &lt;/th&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; n &lt;/th&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; eval_n &lt;/th&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; eval_gl &lt;/th&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; eval_cv &lt;/th&gt;
   &lt;th style="text-align:center;font-weight: bold;color: black !important;"&gt; calidad &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:center;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 1,64 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,10 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,06 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;31&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;623&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; n suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; gl suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; cv &amp;lt;= 0.15 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: green !important;"&gt;fiable&lt;/span&gt; &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:center;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 2,10 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,24 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,12 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;19&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;250&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; n suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; gl suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; cv &amp;lt;= 0.15 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: green !important;"&gt;fiable&lt;/span&gt; &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:center;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 2,41 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,40 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,17 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;19&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;255&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; n suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; gl suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; cv entre 0.15 y 0.3 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: yellow !important;"&gt;poco fiable&lt;/span&gt; &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:center;"&gt; 4 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 2,06 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,39 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,19 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;29&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;273&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; n suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; gl suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; cv entre 0.15 y 0.3 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: yellow !important;"&gt;poco fiable&lt;/span&gt; &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:center;"&gt; 5 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 1,51 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,18 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0,12 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;41&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;"&gt;580&lt;/span&gt; &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; n suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; gl suficiente &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; cv &amp;lt;= 0.15 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; &lt;span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: green !important;"&gt;fiable&lt;/span&gt; &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Utilización de loops

Queremos calcular la proporción para varias variables o indicadores

--

En este caso, queremos la proporción de la Victimización Agregada Delitos Consumados (`VA_DC`)
y Victimización Agregada Intentos de Delito (`VA_ID`) por región.

--

Podemos generar un loop, agregando el parámetro `standard_eval = T`



```r
insumos &lt;- data.frame()
for (var in c("VA_DC", "VA_ID")) {
  insumo &lt;- create_prop(var = var, dominios = "enc_region", disenio = dcHog,
                        standard_eval = T )
  insumos &lt;- bind_rows(insumos, insumo)
}
```
--

Podemos hacer lo mismo, utilizando el paquete `purrr` (mucho más recomendado que un for)



```r
insumos &lt;- map_df(c("VA_DC", "VA_ID"), ~create_mean(var = .x, dominios = "enc_region",
                                                   disenio = dcHog, standard_eval = T ))
```


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Desarrollo open source

El paquete `calidad` es un desarrollo completamente *open source* 

--

Estos proyectos se nutren del aporte de la comunidad

--

En este [repositorio de github](https://github.com/inesscc/calidad) pueden proponer nuevos desarrollos

--

Klaus Lehmann y Ricardo Pizarro seremos los mantenedores 

--

Pueden generar *issues* o nuevas ramas de desarrollo 

--

Si tienen una idea de desarrollo o mejora, estaremos felices de revisarlo e incorporarlo al paquete  

.center[
### 😄😄😄😄😄
]





---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Un poco de práctica

- Calcula la razón de inseguridad en la micro de las mujeres por sobre los hombres a nivel regional
- Evalúa si el tabulado cumple con el estándar
- Genera una visualización de la tabla evaluada

--


```r
enusc$muj_insg_micro = ifelse(enusc$P9_3_1 %in% c(1,2) &amp; enusc$rph_sexo == 2,1 ,0)
enusc$hom_insg_micro = ifelse(enusc$P9_3_1 %in% c(1,2) &amp; enusc$rph_sexo == 1,1 ,0)

dcPers &lt;- svydesign(ids = ~Conglomerado, strata = ~VarStrat,
                    data = enusc, weights = ~Fact_Pers)

est &lt;-  create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi,dominios = enc_region, disenio = dcPers)
evaluate_tot(est, publicar = T) 

tabla_html(est)
```

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Un poco de práctica

- Calcula la proporción de los hogares revictimizado por region  
- Evalúa si el tabulado cumple con el estándar
- Genera una visualización de la tabla evaluada


```r
revict &lt;- create_prop(RVA_DC,dominios = enc_region, subpop = VA_DC, disenio = dcHog)
eval_revict &lt;- evaluate_tot(tramo_region_ocup, publicar = T)
tabla_html(eval_revict)
```

---

class: center, middle

.linea-superior[]
.linea-inferior[]

&lt;img src="imagenes/logo_portada2.png" width="200" /&gt;

## Capacitación en uso paquete calidad

### Diciembre 2021
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
