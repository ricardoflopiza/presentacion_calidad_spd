---
title: "Capacitaci칩n paquete calidad"
subtitle: "calidad"
author: 
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    seal: false
    #lib_dir: libs
    css: xaringan-themer.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: False
---

class: center, middle

.linea-superior[]
.linea-inferior[]

<img src="imagenes/logo_portada2.png" width="200" />

## Capacitaci칩n en uso paquete calidad para 
Subsecretar칤a prevenci칩n del delito

## Subdepartamento condiciones de vida 
**INE**

### Diciembre 2021

```{r setup, include=FALSE}
options(htmltools.dir.version = TRUE)
knitr::opts_chunk$set(message = FALSE, warning = F) 
options(scipen = "999")
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
```

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Estructura del taller


- Breve repaso del est치ndar de calidad para las estimaciones en encuestas de hogares del INE

--

- Recordar de manera general el paquete `survey`

--

- Presentaci칩n y ejercicios pr치cticos con el paquete `calidad`, desarrollado por el PE SSCC. 

--

**Objetivo del taller**

- Presentar principales funciones del paquete de `calidad` para la implementaci칩n del estandar de calidad porpuesto por el INE, con datos de ENUSC.

--

### Asumiremos un conocimiento b치sico de R

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Est치ndar de calidad INE

Desde 2020, el INE cuenta con un [est치ndar](https://www.ine.cl/docs/default-source/documentos-de-trabajo/20200318-lineamientos-medidas-de-precisi%C3%B3n.pdf?sfvrsn=f1ab2dbe_4) para evaluar la calidad de estimaciones provenientes de encuestas de hogares


.center[
<img src="imagenes/estandar.png" width="600" />
]

--

Nos permite determinar si una estimaci칩n es **fiable, poco fiable o no fiable** 

--

Nos orienta respecto a si un tabulado debe ser publicado o no


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Aspectos generales del est치ndar

Existe un flujo, que nos permite etiquetar **autom치ticamente** cada estimaci칩n 

--

.center[
<img src="imagenes/flujo.png" width="650" />
]

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Aspectos generales del est치ndar

## El flujo establece caminos diferenciados

--

### Estimaciones de proporci칩n (o raz칩n) entre **0 y 1**

- Tama침o muestral
- Grados de libertad
- .red[Error est치ndar] 

--

### Resto de estimaciones

- Tama침o muestral
- Grados de libertad
- .red[Coeficiente de variaci칩n] 
 

### En un caso usamos el SE y en otro el CV

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Introducci칩n paquete calidad

### 쮺칩mo pasar del documento a la pr치ctica?

.center[
<img src="https://media.giphy.com/media/a5viI92PAF89q/giphy.gif" width="200" />
]

--

Existen m칰ltiples herramientas (Stata, R, SAS, Python) y todas son v치lidas

--

M칰ltiples modalidades dentro de cada herramienta (libertad total, scripts estandarizados, funciones, etc)

--

Es 칰til contar con una herramienta que **estandarice** los criterios de calidad



---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Introducci칩n paquete calidad

Una posibilidad es el uso de un **paquete (librer칤a)**

--

El paquete `calidad` implementa el est치ndar mediante `R`

--

### Objetivos del paquete

- Facilitar la aplicaci칩n del est치ndar a usuarios externos
- Aumentar la eficiencia en el trabajo de los analistas
- Reducir la probabilidad de error en la implementaci칩n

--

El paquete `calidad` combina el est치ndar del INE con el paquete `survey`, desarrollado por Thomas Lumley


.center[
<img src="imagenes/ecuacion.png" width="450" />
]

--

.center[
### Revisaremos velozmente el paquete survey
]


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Brev칤sima revisi칩n de survey

Usaremos los datos de ENUSC 2020 y 2019


```{r}
library(readr)
library(tidyverse)

# enusc <- haven::read_sav("base-de-datos---xvi-enusc-2019.sav")
enusc <- feather::read_feather("data/enusc2019.feather")

```
--

Construyamos variables necesarias para hacer algunos c치lculos

```{r}
### Seleccionamos a los casos kish 
enusc = enusc[enusc$Kish == 1,]

### percepci칩n de inseguridad por sexo
enusc = enusc %>%  mutate(muj_insg_taxi = dplyr::if_else(enusc$P9_4_1 %in% c(1,2) & enusc$rph_sexo == 2,1 ,0),
                          hom_insg_taxi = dplyr::if_else(enusc$P9_4_1 %in% c(1,2) & enusc$rph_sexo == 1,1 ,0))

enusc$muj_insg_micro = if_else(enusc$P9_3_1 %in% c(1,2) & enusc$rph_sexo == 2,1 ,0)
enusc$hom_insg_micro = if_else(enusc$P9_3_1 %in% c(1,2) & enusc$rph_sexo == 1,1 ,0)

enusc$robo_vehiculo = if_else(enusc$G1_1_1 == 1,1,0)

```

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Brev칤sima revisi칩n de survey

En primer lugar, declaramos el dise침o complejo con la funci칩n `svydesign`
```{r}
library(survey)

### declaramos dise침o complejo con el factor de personas
dcPers <- svydesign(ids = ~Conglomerado, strata = ~VarStrat,
                     data = enusc, weights = ~Fact_Pers)

### declaramos dise침o complejo con el factor de hogares
dcHog <- svydesign(ids = ~Conglomerado, strata = ~VarStrat,
                     data = enusc, weights = ~Fact_Hog)


```

Debemos declarar:
- conglomerados de varianza
- estratos de varianza
- factor de expansi칩n

--

Es importante indicarle a `survey` qu칠 hacer cuando existen estratos que solo tienen una UPM 

```{r}
options(survey.lonely.psu = "certainty")
```


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Brev칤sima revisi칩n de survey

### Ahora podemos usar los paquetes `survey` y  `calidad` para diferentes tipos de c치lculos 游땎游땎游땎游땎游땎

--

**Calculemos la Victimizaci칩n Personal de Delitos Consumados**

```{r}
svymean(x = ~VP_DC,dcPers)
```
--

**Calculemos la Victimizaci칩n Personal de Delitos Consumados por regiones**

```{r}
svyby(formula = ~VP_DC, design = dcPers, by = ~enc_region, FUN = svymean)
```
--

**Calculemos la inseguridad de las mujeres en taxis por sobre los hombres**

```{r, eval=F}
svyratio(numerator = ~muj_insg_taxi, denominator = ~hom_insg_taxi, dcPers)
```
---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Brev칤sima revisi칩n de survey

`survey` permite hacer una infinidad de c치lculos 

- `svymean`
- `svytotal`
- `svyratio`
- `svyby`
- `svyquantile`

--

Mediante la funci칩n `as.svrepdesign` podemos, adem치s, utilizar m칠todos de remuestreo

- intervalos de confianza de percentiles
- cv de percentiles

--

.center[
### El paquete survey es una gran herramienta que nos hace la vida m치s f치cil 
]

.center[
<img src="https://media.giphy.com/media/l3V0dy1zzyjbYTQQM/giphy.gif" width="250" />
]




---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Instalaci칩n paquete calidad

Lo primero, es descargar el paquete desde `github`

Se requiere el paquete `devtools`

```{r, eval=F}
library(devtools)
install_github("inesscc/calidad")
```

--

### En la consola, aparecer치 el siguiente mensaje


.center[
<img src="imagenes/consola.png" width="350" />
]

### Debes escribir 3 en la consola y luego enter

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Panorama general

Lo siguiente, es cargar el paquete en la sesi칩n

```{r}
library(calidad)
```

El paquete `calidad` tiene 2 grandes familias de funciones:

- *create_*: permiten **crear** los insumos para el est치ndar
- *evaluate_*: permiten hacer la **evaluaci칩n** del est치ndar

--

Podemos hacer los siguientes c치lculos

- `create_mean`: calcular la media (edad)
- `create_prop`: proporci칩n o raz칩n (VP_DC, ocupaci칩n) 
- `create_tot`: conteo de unidades (ocupaci칩n)
- `create_tot_con`: suma de variables continuas (ingreso)
- `create_median`: mediana (edad, ingreso)

--

### Estas funciones devuelven la estimaci칩n y los insumos para el est치ndar

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Panorama general

Queremos calcular la edad media para mujeres y hombres

--

```{r, eval=F}
 create_mean(var = edad_numerica, dominios = rph_sexo, disenio = dcPers)
```

- `var`: variable a estimar
- `dominios`: desagregaciones
- `disenio`: dise침o muestral creado con `svydesign`

--

La funci칩n genera:
- estimaci칩n 
- error est치ndar (se)
- grados de libertad (gl)
- tama침o muestral (n)
- coeficiente de variaci칩n (coef_var)

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Panorama general

A diferencia de `survey`, en el paquete `calidad` no es necesario utilizar ~  

```{r, eval=F}
# Argumentos con paquete survey
 svyby(formula = ~rph_edad, by = ~rph_sexo, design =  dcPers, FUN = svymean) 
```


--

Tampoco se requiere que los argumentos est칠n escritos como *strings*

--

Sin embargo, existe la libertad para usar *strings*

```{r}
# Argumentos con paquete calidad
 create_prop(var = "VP_DC", dominios = rph_sexo,  disenio = dcPers)

```

--

Ya veremos por qu칠 podr칤a ser 칰til que los argumentos sean strings

.center[
<img src="https://media.giphy.com/media/xUPGcz2H1TXdCz4suY/giphy.gif" width="150" />
]


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_prop

Calculemos los robos de veh칤culos, 
--

Para ello, contamos con la funci칩n `create_prop`

--

Podr칤amos hacer algo similar a lo anterior


```{r, eval=T}
create_prop(var = robo_vehiculo, disenio = dcHog)

```

--

El problema es que el robo de veh칤culos debe calcularse sobre una subpoblaci칩n espec칤fica (quienes poseen veh칤culos)

--

Para ello, utilizamos el argumento `subpop`

```{r}

enusc$poseen_vehiculo = if_else(enusc$F1_1_1 == 1,1,0)

dcHog <- svydesign(ids = ~Conglomerado, strata = ~VarStrat,
                     data = enusc, weights = ~Fact_Hog)
# G1: Durante los 칰ltimos doce meses, 쯔 usted o a alg칰n miembro de su hogar le fue robado su autom칩vil, camioneta o motocicleta?
create_prop(var = robo_vehiculo, subpop = poseen_vehiculo, disenio = dcHog)
```

--

Es muy importante considerar que la variable **subpop debe ser dummy** 


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_prop

쯈u칠 pasa si queremos desagregar por m치s variables?

--

Se debe agregar otra variable utilizando un signo +

```{r}
create_prop(var = VP_DC, dominios = rph_sexo+enc_region, disenio = dcPers)
```

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_prop

Queremos calcula la percepci칩n de inseguridad de las mujeres cuando viajan taxis por sobre la percepci칩n inseguridad de los hombres. 

$$  \frac{InseguridadTaxisMujeres}{InseguridadTaxisHombres}$$

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_prop

La funci칩n `create_prop` permite incluir el argumento `denominador`

```{r}
create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi, disenio = dcPers)
```
--

Podemos agregar el par치metro `dominios`, si queremos desagregar 


```{r}
 create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi,dominios = enc_region, disenio = dcPers)
```

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: median-mean

Para calcular la media de edad por sexo, usamos la funci칩n `create_mean`

```{r, eval=F}
 create_mean(var = edad_numerica, dominios = rph_sexo, disenio = dcPers)
```
--

Para calcular la mediana, usamos `create_median`

En este caso, el valor por defecto para el n칰mero de r칠plicas es 10, pero podemos elegir el valor que queramos

```{r, eval = F}
 create_median(var = edad_numerica, dominios = rph_sexo, disenio = dcPers, replicas = 50)
```

--

.red[춰춰El tiempo de ejecuci칩n aumenta significativamente con el n칰mero de r칠plicas!!]


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Creando los insumos: create_tot

Si queremos un conteo de casos, podemos usar `create_tot`

--

Por ejemplo, n칰mero de propietarios de veh칤culos por regi칩n

--

```{r}
create_tot(poseen_vehiculo, dominios = enc_region,disenio = dcHog)
```

--

.red[Se requiere que la variable a estimar sea dummy]

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Argumentos adicionales

Hasta el momento hemos revisado 

- `create_prop`
- `create_mean`
- `create_median`
- `create_tot`

--

Todas las funciones del paquete operan de manera similar


--

Contamos argumentos opcionales 

- `ci`: para obtener intervalos de confianza 

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Argumentos adicionales

Queremos calcular el intervalo de confianza para la media de edad

```{r, eval=F}
create_mean(var = edad_numerica, dominios = rph_sexo, disenio = dcPers, ci = T)
```

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

<br>
<br>
<br>
<br>
<br>

.center[
  .big[Evaluaci칩n del est치ndar] 
]


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluaci칩n del est치ndar

Existe una funci칩n de evaluaci칩n para cada tipo de estimaci칩n

- `evaluate_mean`
- `evaluate_prop`
- `evaluate_tot`
- `evaluate_tot_con`
- `evaluate_median`

--

Estas funciones reciben como argumento la tabla creada por las funciones `create_*`



---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluaci칩n del est치ndar

Evaluemos si la victimizaci칩n acumulada, cumple con el est치ndar

--

```{r}

 est <- create_prop(var = VA_DC, dominios = rph_sexo, disenio = dcHog)
 evaluate_mean(est)

```

--

Tenemos 4 columnas nuevas

- `eval_n`: indica si el tama침o muestral es suficiente
- `eval_gl`: indica si los gl son suficientes
- `eval_cv`: indica el tramo en el que est치 el cv
- `calidad`: evaluaci칩n final de la estimaci칩n


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluaci칩n del est치ndar

Veamos el caso de Victimizaci칩n de Delitos Consumados

```{r}
 est <- create_prop(var = VP_DC, dominios = enc_region, disenio = dcPers)
 evaluate_prop(est)
```
--

Adem치s de las columnas ya vistas, tenemos 

- `prop_est`
- `tipo_eval`
- `cuadratica`
- `eval_se`
- `eval_cv`

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluaci칩n del est치ndar

Veamos qu칠 pasa con las proporciones que son mayores a 1, como la percepci칩n de inseguridad en taxis

```{r}
 est <- create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi,dominios = enc_region, disenio = dcPers)
 evaluate_prop(est)

```

--

**En este caso, usamos el CV para hacer la evaluaci칩n y no el SE** 


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Evaluaci칩n del est치ndar

El est치ndar se침ala que un tabulado puede ser publicado si el 50% de sus celdas es fiable

--

Para saber si el tabulado debe ser publicado, usamos el argumento `publicar`

```{r}
est <-  create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi,dominios = enc_region, disenio = dcPers)
evaluate_tot(est, publicar = T) %>%
  select(enc_region, objetivo, calidad, publicacion, aprueba) %>%
  slice(1:6)
```

--

Tenemos 2 nuevas columnas

- `publicacion`: evaluaci칩n general del tabulado
- `aprueba`: porcentaje de celdas con categor칤a fiable

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Visualizaci칩n est치ndar

La funci칩n `tabla_html` a칰n est치 en desarrollo, pero ya est치 disponible para ser usada

Recibe como argumento el output de `evaluate` 


```{r}

 tabla_html(evaluate_tot(est) %>% slice(1:5)) 


```


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Utilizaci칩n de loops

Queremos calcular la proporci칩n para varias variables o indicadores

--

En este caso, queremos la proporci칩n de la Victimizaci칩n Agregada Delitos Consumados (`VA_DC`)
y Victimizaci칩n Agregada Intentos de Delito (`VA_ID`) por regi칩n.

--

Podemos generar un loop, agregando el par치metro `standard_eval = T`


```{r}

insumos <- data.frame()
for (var in c("VA_DC", "VA_ID")) {
  insumo <- create_prop(var = var, dominios = "enc_region", disenio = dcHog,
                        standard_eval = T )
  insumos <- bind_rows(insumos, insumo)
}

```
--

Podemos hacer lo mismo, utilizando el paquete `purrr` (mucho m치s recomendado que un for)


```{r}
insumos <- map_df(c("VA_DC", "VA_ID"), ~create_mean(var = .x, dominios = "enc_region",
                                                   disenio = dcHog, standard_eval = T ))
```


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Desarrollo open source

El paquete `calidad` es un desarrollo completamente *open source* 

--

Estos proyectos se nutren del aporte de la comunidad

--

En este [repositorio de github](https://github.com/inesscc/calidad) pueden proponer nuevos desarrollos

--

Klaus Lehmann y Ricardo Pizarro seremos los mantenedores 

--

Pueden generar *issues* o nuevas ramas de desarrollo 

--

Si tienen una idea de desarrollo o mejora, estaremos felices de revisarlo e incorporarlo al paquete  

.center[
### 游땏游땏游땏游땏游땏
]





---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Un poco de pr치ctica

- Calcula la raz칩n de inseguridad en la micro de las mujeres por sobre los hombres a nivel regional
- Eval칰a si el tabulado cumple con el est치ndar
- Genera una visualizaci칩n de la tabla evaluada

--

```{r, eval=F}

enusc$muj_insg_micro = ifelse(enusc$P9_3_1 %in% c(1,2) & enusc$rph_sexo == 2,1 ,0)
enusc$hom_insg_micro = ifelse(enusc$P9_3_1 %in% c(1,2) & enusc$rph_sexo == 1,1 ,0)

dcPers <- svydesign(ids = ~Conglomerado, strata = ~VarStrat,
                    data = enusc, weights = ~Fact_Pers)

est <-  create_prop(var = muj_insg_taxi, denominador = hom_insg_taxi,dominios = enc_region, disenio = dcPers)
evaluate_tot(est, publicar = T) 

tabla_html(est)

```

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Un poco de pr치ctica

- Calcula la proporci칩n de los hogares revictimizado por region  
- Eval칰a si el tabulado cumple con el est치ndar
- Genera una visualizaci칩n de la tabla evaluada

```{r, eval=F}

revict <- create_prop(RVA_DC,dominios = enc_region, subpop = VA_DC, disenio = dcHog)
eval_revict <- evaluate_tot(tramo_region_ocup, publicar = T)
tabla_html(eval_revict)

```

---

class: center, middle

.linea-superior[]
.linea-inferior[]

<img src="imagenes/logo_portada2.png" width="200" />

## Capacitaci칩n en uso paquete calidad

### Diciembre 2021
